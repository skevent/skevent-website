# Replication Blueprint

**Status:** APPROVED
**Version:** 1.0.0
**Purpose:** Rebuild the exact system functionality without seeing original code.

---

## 1Ô∏è‚É£ SYSTEM OVERVIEW

A serverless full-stack event booking platform.
*   **Frontend:** Vanilla JS + Vite (Static Build).
*   **Backend:** Vercel Serverless Functions (`/api`).
*   **Database:** Supabase (PostgreSQL).
*   **Auth:** Supabase Auth (Email/Password + Custom OTP for verification).
*   **Payments:** Razorpay (Order creation + Webhook verification).
*   **Email:** Resend.
*   **Deployment:** Vercel (Frontend + Backend).

### Runtime Assumptions
*   **Node Version:** 18.x or 20.x.
*   **Build Command:** `vite build`.
*   **Output Directory:** `dist`.
*   **CORS:** Handled by `cors` middleware or Vercel `vercel.json` headers.

---

## 2Ô∏è‚É£ EXACT BACKEND IMPLEMENTATION DETAILS

### Structure
*   **Framework:** Native Vercel Functions (Node.js).
*   **Entry Points:** File-based routing in `api/`.
    *   `api/index.js` (Optional health check).
    *   `api/create-razorpay-order.js` (Payment initialization).
    *   `api/razorpay-webhook.js` (Payment confirmation).
    *   `api/send-booking-email.js` (Transactional email).
    *   `api/auth/send-otp.js` (Custom auth limit).
    *   `api/auth/verify-otp.js` (Custom auth verification).
*   **Shared Logic:** `api/_utils/`
    *   `supabaseAdmin.js`: `createClient` using `SUPABASE_SERVICE_ROLE_KEY`. Bypass RLS for payments/admin ops.
    *   `resend.js`: `resend` client initialization.

### Critical Logic Rules
1.  **Price Calculation:** MUST happen on the backend (`create-razorpay-order.js`). NEVER trust the frontend price.
2.  **Influencer Discounts:**
    *   Fetch `influencer_code` from request.
    *   Look up `influencers` table via Admin Client.
    *   Apply `discount_percent` to base price.
    *   Round to nearest integer (in paise for Razorpay).
3.  **Booking Lifecycle:**
    *   **Step 1:** Create Razorpay Order (Pending state). Update `bookings` table with `status: 'pending'`, `razorpay_order_id`.
    *   **Step 2:** Webhook receives `order.paid`.
    *   **Step 3:** Webhook validates signature (`x-razorpay-signature`).
    *   **Step 4:** Webhook updates `bookings` status to `paid`.
    *   **Step 5:** Webhook triggers email sending via Resend.
4.  **Free Events:**
    *   Frontend allows direct insertion to `bookings` (if status='paid' and amount=0).
    *   **Security Risk Note:** Replicate this *exactly* as is, but ensure RLS policy allows `INSERT` on bookings depending on implementation (Client currently inserts directly).
5.  **Email Idempotency:** Check `email_sent_at` column in `bookings` before sending to avoid duplicates.

---

## 3Ô∏è‚É£ EXACT FRONTEND IMPLEMENTATION DETAILS

### Architecture
*   **Router:** No client-side router. Multi-page app (MPA).
    *   `/index.html`: Home.
    *   `/event.html?id=UNQ_ID`: Event Details.
    *   `/book.html?id=UNQ_ID`: Booking Flow.
    *   `/login.html`: Auth.
    *   `/success.html`: Booking Confirmation.
    *   `/admin/index.html`: Admin Dashboard.
    *   `/influencer/index.html`: Influencer Dashboard.
*   **State Management:** URL Query Parameters (`?id=...`) drives state.
*   **Data Fetching:** Direct Supabase Client (Anon Key).
    *   `supabase.from('events').select('*')...`

### Auth State
*   `main.js` checks `supabase.auth.getSession()` on load.
*   If session exists:
    *   Hide "Login" button.
    *   Show "Profile" dropdown (Avatar + Logout).
    *   Fetch `profiles` table to get Role ('admin', 'influencer', 'user').
    *   If Role = 'admin'/'influencer', show Dashboard link.

### Form Handling
*   **Contact Form:** `fetch` to generic endpoint (`API_URL` or simple wrapper).
*   **Booking Form:**
    *   Validate inputs.
    *   Check Promocode (fetch `influencers` table).
    *   Calculate local total for display.
    *   Submit -> calls `/api/create-razorpay-order`.

---

## 4Ô∏è‚É£ UI & UX RULES

*   **Design System:** CSS Variables in `style.css`.
*   **Premium Aesthetic:**
    *   Dark Mode default (`#121212` bg).
    *   Gold Accents (`#ffd700`).
    *   Font: Inter (Body), Poppins (Headings).
*   **Responsiveness:**
    *   **Mobile:** Hamburger menu (slide-in from right).
    *   **Grids:** `repeat(auto-fit, minmax(300px, 1fr))` for cards.
    *   **Images:** `object-fit: cover` always.
*   **Animations:**
    *   `fade-in-up` on scroll using `IntersectionObserver`.
    *   Hover effects: Scale up (1.05x), Box shadow glow.

---

## 5Ô∏è‚É£ BRANDING & VISUAL ASSETS CONTRACT

*   **Config:** All colors in `style.css` `:root`.
*   **Logo:** Text-based in HTML (`.brand-title` + `.brand-subtitle`).
*   **Images:**
    *   Events have `image_url` in DB.
    *   Influencers have `image_url` in DB.
    *   Fallbacks: Unsplash URLs hardcoded in JS files.
*   **New Client Injection:**
    *   Change `:root` colors.
    *   Update HTML Title/Favicon.
    *   Update Text Logo in `index.html` (header).

---

## 6Ô∏è‚É£ AUTH PAGES REQUIREMENTS

*   **Login/Signup:** Single page toggle.
*   **Logic:**
    *   Email/Password via `supabase.auth.signInWithPassword`.
    *   Signup: `supabase.auth.signUp`.
*   **Redirects:**
    *   On success -> Reload or Home.
    *   If Admin/Influencer -> Dashboard.

---

## 7Ô∏è‚É£ STORAGE USAGE CONTRACT

*   **Bucket:** `images` (Standard Supabase bucket).
*   **Usage:**
    *   Influencers upload profile pics.
    *   Admins upload event banners.
*   **Access:**
    *   Public: READ.
    *   Authenticated (Owner): UPLOAD/UPDATE.

---

## 8Ô∏è‚É£ ENVIRONMENT VARIABLES CONTRACT

**Client (Vite):**
*   `VITE_SUPABASE_URL`: Public.
*   `VITE_SUPABASE_ANON_KEY`: Public.

**Server (`.env.local` / Vercel):**
*   `SUPABASE_SERVICE_ROLE_KEY`: Critical. Admin access.
*   `RAZORPAY_KEY_ID`: Public/Safe.
*   `RAZORPAY_KEY_SECRET`: Private.
*   `RAZORPAY_WEBHOOK_SECRET`: Private.
*   `RESEND_API_KEY`: Private.

---

## 9Ô∏è‚É£ DATABASE & SECURITY ASSUMPTIONS

### Schema (Inferred & Explicit)

#### `events`
*   `id` (uuid, PK)
*   `title` (text)
*   `date` (timestamptz)
*   `location` (text)
*   `price` (numeric, default 0)
*   `image_url` (text)
*   `description` (text)
*   `external_link` (text, nullable)

#### `bookings`
*   `id` (uuid, PK)
*   `created_at` (timestamptz)
*   `event_id` (uuid, FK events)
*   `customer_name` (text)
*   `customer_email` (text)
*   `customer_phone` (text)
*   `amount` (numeric)
*   `status` (text: 'pending', 'paid')
*   `razorpay_order_id` (text)
*   `influencer_code` (text, nullable)
*   `email_sent_at` (timestamptz, nullable)

#### `influencers`
*   `id` (uuid, PK)
*   `code` (text, Unique)
*   `discount_percent` (int)
*   `active` (bool)
*   `image_url` (text)
*   `name` (text)
*   `instagram` (text)
*   ... (social links)

#### `profiles` (extends auth.users)
*   `id` (uuid, PK, ref auth.users)
*   `full_name` (text)
*   `role` (text: 'user', 'admin', 'influencer')
*   `email_otp`... (custom auth fields)

### RLS Policies
*   **Events:** Public Read. Admin Write.
*   **Influencers:**
    *   Public Read (Code, Discount, Active ONLY).
    *   Owner Read/Update (Own Profile).
*   **Bookings:**
    *   Public Insert (required for Free booking flow).
    *   Service Role Update (Webhooks).
    *   User Read (Own bookings).

---

## üîü STEP-BY-STEP REPLICATION CHECKLIST

1.  **Init Project:** `npm create vite@latest .`
2.  **Dependencies:** `npm install @supabase/supabase-js razorpay resend express cors dotenv`.
3.  **Supabase Setup:**
    *   Run SQL scripts to create tables.
    *   Enable Auth (Email).
    *   Create Storage Bucket `images` (Public).
4.  **Environment:** Set `.env` with keys.
5.  **Backend:**
    *   Copy `api/` folder structure exactly.
    *   Ensure `vercel.json` has rewrites for `/event.html` and `/book.html`.
6.  **Frontend:**
    *   Copy `*.html`, `*.js`, `style.css`.
    *   Ensure strict file-based routing logic is maintained.
7.  **Verify:**
    *   Test Razorpay Test Mode.
    *   Test Email Delivery.
    *   Test Admin Dashboard access.

**NEVER CHANGE:**
*   The Razorpay Order Creation logic (Server-side price calc).
*   The Webhook signature verification.
